# ==========================================
# Refresh Token Implementation Flow (auth)
# ==========================================

This document describes the **exact refresh-token flow** as implemented in the project,
based strictly on the provided PDF and existing source code.

---

## Refresh Token Flow – Table of Contents

0. Preconditions  
1. Controller endpoint (`/auth/refresh`)  
2. Request validation (`RefreshTokenRequestDto`)  
3. AuthService.refreshToken (business logic)  
4. Refresh token lookup & validation rules  
5. One-time use (revocation) behavior  
6. Generate new tokens  
7. Redis allow-list handling  
8. Response  
9. Error handling  
10. Test flow  

---

## 0. Preconditions

The following components already exist and are reused:

- `RefreshToken` entity (`refresh_tokens` table)
- `RefreshTokenRepository.findByToken(...)`
- `JwtTokenProvider`
- `TokenAllowListService`
- Stateless Spring Security configuration

---

## 1. Controller endpoint (`/auth/refresh`)

- Endpoint: `POST /auth/refresh`
- Request body: `RefreshTokenRequestDto`
- Uses `@Valid`
- Delegates to `authService.refreshToken(request)`
- Returns **200 OK** with `AuthResponseDto`

---

## 2. Request validation (`RefreshTokenRequestDto`)

Field:
- `refreshToken`

Validations:
- `@NotBlank` on `refreshToken`

Validation behavior:
- DTO validation is handled by Spring before entering service logic.
- Validation errors result in `MethodArgumentNotValidException`
  handled by `GlobalExceptionHandler` → **400 Bad Request**.

---

## 3. AuthService.refreshToken (business logic)

Method:
```

refreshToken(RefreshTokenRequestDto request)

```

### Steps

1. Read refresh token string:
   - `String token = request.refreshToken()`
2. Load refresh token from DB:
   - `refreshTokenRepository.findByToken(token)`
   - If not found → throw `RefreshTokenException("Refresh token not found")`
3. Validate refresh token state:
   - If `revoked == true` → throw `RefreshTokenException("Refresh token is revoked")`
   - If `expiryDate` is before `now` → throw `RefreshTokenException("Refresh token is expired")`
4. Get the user from refresh token:
   - `User user = refreshToken.getUser()`
5. Revoke the used refresh token (one-time use):
   - `refreshToken.setRevoked(true)`
   - `refreshTokenRepository.save(refreshToken)`
6. Generate new tokens:
   - `newAccessToken = jwtTokenProvider.generateToken(user)`
   - `newRefreshToken = createRefreshToken(user)`
7. Add new access token to Redis allow-list:
   - `tokenAllowListService.add(newAccessToken, user.getUsername())`
8. Return `AuthResponseDto`

---

## 4. Refresh token lookup & validation rules

### Lookup
- Lookup is performed by `RefreshTokenRepository.findByToken(String token)`.

### Validation rules (exact)
- If refresh token is missing in DB → **not found**
- If refresh token is revoked → **revoked**
- If refresh token is expired → **expired**

All of the above cases throw `RefreshTokenException` with a specific message.

---

## 5. One-time use (revocation) behavior

- The refresh token used in `/auth/refresh` is revoked immediately:
  - `refreshToken.setRevoked(true)`
  - persisted via `refreshTokenRepository.save(refreshToken)`

This makes refresh tokens **single-use** in the current implementation.

---

## 6. Generate new tokens

### New access token
Generated using `JwtTokenProvider`:

- Subject: `username`
- Claim: `role`
- Expiration: `jwt.expiration`
- Signing algorithm: HS256
- Secret key derived from `jwt.secret`

### New refresh token
Generated by `createRefreshToken(user)`:

- token value: random UUID
- expiry: now + **30 days**
- `revoked = false`
- saved in `refresh_tokens`

---

## 7. Redis allow-list handling

After successful refresh:

- New access token is added to Redis allow-list

Details:
- Key format: `auth:allowlist:<newAccessToken>`
- Value: `username`
- TTL: same as `jwt.expiration`

Implementation note:
- Redis connection parameters are currently **hardcoded in `RedisConfig`**.

---

## 8. Response

Returned object:

```

AuthResponseDto(
tokenType = "Bearer",
newAccessToken,
newRefreshToken,
username
)

```

Controller response:
- HTTP **200 OK**
- Body: `AuthResponseDto`

---

## 9. Error handling

### Validation errors (DTO)
- Exception: `MethodArgumentNotValidException`
- Response: **400 Bad Request**

### Refresh token errors
- Exception: `RefreshTokenException`
- Response: **401 Unauthorized**
- Message is one of:
  - `"Refresh token not found"`
  - `"Refresh token is revoked"`
  - `"Refresh token is expired"`

### Other runtime errors
- Not explicitly handled and may result in default error response.

---

## 10. Test Flow

### 10.1 Successful refresh
- Provide a valid, existing, not revoked, not expired refresh token
- Expect:
  - HTTP **200**
  - new accessToken present
  - new refreshToken present
  - new access token exists in Redis allow-list
  - old refresh token is now revoked in DB

### 10.2 Refresh token not found
- Provide a random/unknown refresh token
- Expect:
  - HTTP **401 Unauthorized**
  - message: `"Refresh token not found"`

### 10.3 Refresh token revoked (reused token)
- Use the same refresh token twice
- Expect on second call:
  - HTTP **401 Unauthorized**
  - message: `"Refresh token is revoked"`

### 10.4 Refresh token expired
- Use an expired refresh token
- Expect:
  - HTTP **401 Unauthorized**
  - message: `"Refresh token is expired"`

### 10.5 Validation error
- Blank refresh token in body
- Expect:
  - HTTP **400 Bad Request**

---

End of Refresh Token Flow

---
